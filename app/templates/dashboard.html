{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Dashboard</h1>
        <div class="btn-group" role="group">
            {% if current_user.is_admin %}
                {% if sync_status and sync_status.has_active_sync %}
                    <button class="btn btn-outline-secondary" disabled id="syncButton">
                        Syncing...
                    </button>
                {% else %}
                    <form action="{{ url_for('main.sync_playlists') }}" method="POST" class="d-inline" onsubmit="showSyncLoader()">
                        <button type="submit" class="btn btn-outline-primary" id="syncButton" data-analytics="sync_playlists_click">
                            <span id="syncButtonText">üîÑ Sync Playlists</span>
                            <span id="syncButtonLoader" class="d-none">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                Syncing...
                            </span>
                        </button>
                    </form>
                {% endif %}
            {% endif %}
            <button class="btn btn-outline-secondary" onclick="location.reload()">
                üîÑ Refresh
            </button>
        </div>
    </div>

    {% if current_user and current_user.is_authenticated %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <p class="lead mb-0">Welcome back, {{ current_user.display_name | default('User') }}!</p>
            <div class="text-end">
                {% if last_sync_info and last_sync_info.last_sync_at %}
                    <small class="text-muted">
                        üîÑ
                        Last sync: <span id="lastSync" data-timestamp="{{ last_sync_info.last_sync_at }}">{{ last_sync_info.last_sync_at }}</span><br>
                    </small>
                {% endif %}
                {% if sync_status and sync_status.checked_at %}
                    <small class="text-muted">
                        ‚è∞
                        Status checked: <span id="lastChecked" data-timestamp="{{ sync_status.checked_at }}">{{ sync_status.checked_at }}</span>
                    </small>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Analysis Confirmation Modal -->
    {% if session.get('show_analysis_modal') %}
    <div class="modal fade show" id="analysisModal" tabindex="-1" aria-labelledby="analysisModalLabel" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: var(--border-radius); border: none; box-shadow: var(--box-shadow-lg);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, rgba(107, 70, 193, 0.05) 0%, rgba(159, 122, 234, 0.03) 100%);">
                    <h5 class="modal-title fw-bold" id="analysisModalLabel" style="color: var(--primary-purple);">
                        üéâ {% if session.sync_info.get('is_new_user') %}Welcome to Music Disciple!{% else %}Library Update{% endif %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="dismissAnalysisModal()"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    {% set sync_info = session.sync_info %}
                    {% if sync_info.get('is_new_user') %}
                        <p class="mb-3">We found <strong>{{ sync_info.playlists_count }} playlists</strong> with <strong>{{ sync_info.tracks_count }} songs</strong> in your Spotify library.</p>
                        <p class="mb-4">Would you like to analyze them now? This will take approximately <strong>{{ ((sync_info.tracks_count * 2) / 60) | round(0, 'ceil') | int }} minutes</strong>.</p>
                    {% elif sync_info.get('is_update') %}
                        <p class="mb-3">We detected changes in <strong>{{ sync_info.playlists_count }} playlists</strong> with new songs.</p>
                        <p class="mb-4">Would you like to analyze the updated content now?</p>
                    {% elif sync_info.get('is_resume') %}
                        <p class="mb-3">You have <strong>{{ sync_info.unanalyzed_count }} unanalyzed songs</strong> in your library.</p>
                        <p class="mb-4">Would you like to continue analyzing them now?</p>
                    {% endif %}
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" onclick="startAnalysisFromModal()" style="background: linear-gradient(135deg, var(--primary-purple) 0%, var(--primary-color) 100%); border: none; box-shadow: 0 4px 12px rgba(107, 70, 193, 0.25);">
                            ‚úÖ Yes, Analyze Now
                        </button>
                        <button class="btn btn-outline-secondary" onclick="dismissAnalysisModal()">
                            ‚è∏Ô∏è Maybe Later
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if error_message %}
        <div class="alert alert-danger" role="alert">
            ‚ö†Ô∏è {{ error_message }}
        </div>
    {% endif %}

    <!-- Analysis Controls -->
    {% set total_songs_safe = stats.total_songs|default(0, true)|int %}
    {% set analyzed_safe = stats.analyzed_songs|default(0, true)|int %}
    {% if total_songs_safe > analyzed_safe %}
    <div id="unanalyzedSongsAlert" class="alert alert-info" role="alert">
        ‚ÑπÔ∏è
        You have {{ stats.total_songs - stats.analyzed_songs }} unanalyzed songs. Click "Analyze All" to start.
        <button id="start-analysis-btn" class="btn btn-primary btn-sm ms-2" data-analytics="analyze_all_click">
            ‚ñ∂Ô∏è Analyze All
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Song Analysis Progress Indicator (ONLY ONE) -->
    <div id="analysisProgressAlert" class="alert alert-warning" role="alert" style="display: none;">
        <div class="d-flex align-items-center mb-3">
            üß†
            <div class="flex-grow-1">
                <strong>Song Analysis in Progress</strong>
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <span id="analysisMessage">Analyzing song content...</span>
                    <div class="text-end">
                        <small class="text-muted">
                            <span id="analysisElapsed">0:00</span> elapsed
                            ‚Ä¢ ETA: <span id="analysisETA">calculating...</span>
                        </small>
                    </div>
                </div>
            </div>
            <button type="button" class="btn-close" onclick="hideAnalysisProgress()" aria-label="Close"></button>
        </div>

        <!-- Analysis Progress Bar -->
        <div class="progress mb-2" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                 role="progressbar"
                 style="width: 25%"
                 id="analysisProgress">
                <span class="progress-text fw-bold">Starting analysis...</span>
            </div>
        </div>

        <!-- Analysis Details -->
        <div class="row text-center mt-3">
            <div class="col-4">
                <div class="analysis-stat">
                    <div class="analysis-number text-success" id="analysisCompleted">0</div>
                    <div class="analysis-label">Completed</div>
                </div>
            </div>
            <div class="col-4">
                <div class="analysis-stat">
                    <div class="analysis-number text-warning" id="analysisInProgress">0</div>
                    <div class="analysis-label">In Progress</div>
                </div>
            </div>
            <div class="col-4">
                <div class="analysis-stat">
                    <div class="analysis-number text-info" id="analysisPending">0</div>
                    <div class="analysis-label">Pending</div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <strong>Current:</strong> <span id="currentJob">Background analysis for {{ current_user.display_name }}</span><br>
            <strong>Recent:</strong> <span id="recentJobs">None</span>
        </div>
    </div>

    <!-- Quick Stats Section (ONLY ONE) -->
    <div class="row mb-4 g-3" data-stat-card>
        <div class="col-md-4">
            <div class="card text-center h-100 border-primary">
                <div class="card-body">
                    <h5 class="card-title text-primary">Total Playlists</h5>
                    <p class="card-text fs-2 fw-bold text-primary" id="totalPlaylists">{{ stats.total_playlists }}</p>
                    <small class="text-muted">
                        {% if (stats.total_songs|default(0, true)) > 0 %}
                            {{ stats.total_songs|default(0, true) }} total songs
                        {% else %}
                            No playlists synced yet
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-4" data-stat-card>
            <div class="card text-center h-100 border-info">
                <div class="card-body">
                    <h5 class="card-title text-info">Songs Analyzed</h5>
                    <p class="card-text fs-2 fw-bold text-info" id="totalAnalyzedSongs">{{ analyzed_safe }}</p>
                    <small class="text-muted">
                        {% if total_songs_safe > 0 %}
                            <span id="analysisPercentage">{{ '%.1f'|format((analyzed_safe / total_songs_safe) * 100) }}</span>% of total songs
                        {% else %}
                            Ready for analysis
                        {% endif %}
                    </small>
                    <!-- Analysis Progress Mini-Bar -->
                    {% if total_songs_safe > 0 %}
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-info"
                             role="progressbar"
                             style="width: {{ '%.1f'|format((analyzed_safe / (total_songs_safe if total_songs_safe > 0 else 1)) * 100) }}%"
                             id="miniAnalysisProgress">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4" data-stat-card>
            <div class="card text-center h-100 border-success">
                <div class="card-body">
                    <h5 class="card-title text-success">Clean Playlists</h5>
                    <p class="card-text fs-2 fw-bold text-success" id="cleanPlaylists">{{ stats.clean_playlists if stats.clean_playlists is not none else '-' }}</p>
                    <small class="text-muted">
                        {% if stats.total_playlists is number and stats.total_playlists > 0 and stats.clean_playlists is number %}
                            {{ '%.1f'|format((stats.clean_playlists / stats.total_playlists) * 100) }}% of playlists
                        {% else %}
                            Score ‚â• 75%
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Your Spotify Playlists</h2>
        {% if pagination %}
            <small class="text-muted">
                Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }}-{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page <= pagination.total_items else pagination.total_items }}
                of {{ pagination.total_items }} playlists
            </small>
        {% elif playlists %}
            <small class="text-muted">{{ playlists|length }} playlists found</small>
        {% endif %}
    </div>

    <!-- Search/Filter/Sort Bar -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">üîç</span>
                <input class="form-control" type="search" id="playlistSearchInput" placeholder="Search playlists by name or description..." aria-label="Search">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="scoreFilter">
                <option value="">Filter by Score</option>
                <option value="high">High Score (‚â•75%)</option>
                <option value="medium">Medium Score (50-74%)</option>
                <option value="low">Low Score (<50%)</option>
                <option value="unanalyzed">Not Analyzed</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="sortSelect" onchange="window.location.href = this.value;">
                <option value="{{ url_for('main.dashboard', sort='updated-desc') }}" {% if current_sort == 'updated-desc' %}selected{% endif %}>Sort: Recently Updated</option>
                <option value="{{ url_for('main.dashboard', sort='name-asc') }}" {% if current_sort == 'name-asc' %}selected{% endif %}>Sort: Name (A-Z)</option>
                <option value="{{ url_for('main.dashboard', sort='name-desc') }}" {% if current_sort == 'name-desc' %}selected{% endif %}>Sort: Name (Z-A)</option>
                <option value="{{ url_for('main.dashboard', sort='score-desc') }}" {% if current_sort == 'score-desc' %}selected{% endif %}>Sort: Score (High to Low)</option>
                <option value="{{ url_for('main.dashboard', sort='score-asc') }}" {% if current_sort == 'score-asc' %}selected{% endif %}>Sort: Score (Low to High)</option>
                <option value="{{ url_for('main.dashboard', sort='tracks-desc') }}" {% if current_sort == 'tracks-desc' %}selected{% endif %}>Sort: Most Songs</option>
                <option value="{{ url_for('main.dashboard', sort='tracks-asc') }}" {% if current_sort == 'tracks-asc' %}selected{% endif %}>Sort: Fewest Songs</option>
                <option value="{{ url_for('main.dashboard', sort='analyzed-desc') }}" {% if current_sort == 'analyzed-desc' %}selected{% endif %}>Sort: Recently Analyzed</option>
            </select>
        </div>
    </div>

    {% if playlists %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="playlistGrid">
            {% for playlist in playlists %}
                <div class="col playlist-item"
                     data-score="{{ playlist.score * 100 if playlist.score is not none else 'null' }}"
                     data-name="{{ playlist.name|lower }}"
                     data-description="{{ playlist.description|lower if playlist.description else '' }}"
                     data-tracks="{{ playlist.track_count or 0 }}">
                    {% set is_unlocked = (not unlocked_playlist_id) or (playlist.id == unlocked_playlist_id) or current_user.is_admin %}
                    <div class="card h-100 shadow-sm playlist-card-custom position-relative">
                        {# Simplified: Use single playlist image or fallback icon #}
                        {% if playlist.image_url %}
                            <img src="{{ playlist.image_url }}" class="card-img-top" alt="{{ playlist.name }} cover" style="height: 200px; object-fit: cover;" referrerpolicy="no-referrer" loading="lazy" onerror="this.src='{{ url_for('static', filename='images/default_album_art.png') }}'">
                        {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <div class="text-muted" style="font-size: 3rem;">üéµ</div>
                            </div>
                        {% endif %}
                        <div class="card-body d-flex flex-column {% if not is_unlocked %}blurred-overlay{% endif %}">
                            <h5 class="card-title">{{ playlist.name }}</h5>
                            <p class="card-text text-muted small">
                                {{ playlist.description | truncate(100) if playlist.description else 'No description available.' }}
                            </p>
                            <div class="mt-auto">
                                <ul class="list-unstyled mb-3 text-muted small">
                                    <li class="d-flex justify-content-between">
                                        <span>Tracks:</span>
                                        <strong>{{ playlist.track_count or 0 }}</strong>
                                    </li>
                                    <li class="d-flex justify-content-between">
                                        <span>Score:</span>
                                        {% if playlist.score is not none %}
                                            {% set score_percent = playlist.score * 100 %}
                                            <strong class="
                                                {% if score_percent >= 75 %}text-success
                                                {% elif score_percent >= 50 %}text-warning
                                                {% else %}text-danger
                                                {% endif %}
                                            ">{{ '%.1f%%' % score_percent }}</strong>
                                        {% else %}
                                            <strong class="text-muted">Not Analyzed</strong>
                                        {% endif %}
                                    </li>
                                </ul>
                                <a href="{{ url_for('main.playlist_detail', playlist_id=playlist.id) }}"
                                   class="btn btn-primary btn-sm w-100 mb-2" {% if not is_unlocked %}disabled aria-disabled="true"{% endif %} data-analytics="view_playlist_click">
View Details
                                </a>

                            </div>
                        </div>
                        {% if not is_unlocked %}
                        <div class="upgrade-banner">
                            <div>
                                <div class="fw-bold">Free tier</div>
                                <small>Upgrade to analyze this playlist</small>
                            </div>
                           <a href="#" class="btn btn-warning btn-sm" data-analytics="upgrade\_click">Upgrade</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Pagination Controls / Load More -->
        {% if pagination and pagination.total_pages > 1 %}
        <nav aria-label="Playlist pagination" class="mt-4 d-none d-md-block">
            <div class="row align-items-center">
                <div class="col-auto">
                    <p class="text-muted mb-0">
                        Page {{ pagination.page }} of {{ pagination.total_pages }}
                    </p>
                </div>
                <div class="col">
                    <ul class="pagination justify-content-center mb-0">
                        <!-- First Page -->
                        {% if pagination.page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.dashboard', page=1, sort=current_sort) }}" aria-label="First">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;</span>
                        </li>
                        {% endif %}

                        <!-- Previous Page -->
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.dashboard', page=pagination.prev_num, sort=current_sort) }}" aria-label="Previous">
                                <span aria-hidden="true">&lsaquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&lsaquo;</span>
                        </li>
                        {% endif %}

                        <!-- Page Numbers -->
                        {% set start_page = 1 if pagination.page - 2 < 1 else pagination.page - 2 %}
                        {% set end_page = pagination.total_pages if pagination.page + 2 > pagination.total_pages else pagination.page + 2 %}

                        {% if start_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.dashboard', page=1, sort=current_sort) }}">1</a>
                        </li>
                        {% if start_page > 2 %}
                        <li class="page-item disabled">
                            <span class="page-link">‚Ä¶</span>
                        </li>
                        {% endif %}
                        {% endif %}

                        {% for page_num in range(start_page, end_page + 1) %}
                            {% if page_num == pagination.page %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.dashboard', page=page_num, sort=current_sort) }}">{{ page_num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if end_page < pagination.total_pages %}
                        {% if end_page < pagination.total_pages - 1 %}
                        <li class="page-item disabled">
                            <span class="page-link">‚Ä¶</span>
                        </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.dashboard', page=pagination.total_pages, sort=current_sort) }}">{{ pagination.total_pages }}</a>
                        </li>
                        {% endif %}

                        <!-- Next Page -->
                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.dashboard', page=pagination.next_num, sort=current_sort) }}" aria-label="Next">
                                <span aria-hidden="true">&rsaquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&rsaquo;</span>
                        </li>
                        {% endif %}

                        <!-- Last Page -->
                        {% if pagination.page < pagination.total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.dashboard', page=pagination.total_pages, sort=current_sort) }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
        <div class="d-grid gap-2 d-md-none mt-3">
            {% if pagination.has_next %}
            <a class="btn btn-outline-primary" href="{{ url_for('main.dashboard', page=pagination.next_num, sort=current_sort) }}" id="loadMoreBtn">
                ‚ûï Load more
            </a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <div class="text-success mb-4" style="font-size: 4rem;">üéµ</div>
            <h4>Ready to Sync Your Playlists!</h4>
            {% if error_message %}
                <p class="text-muted">There was an error loading your playlists. Please try refreshing the page.</p>
                <button class="btn btn-primary mt-3" onclick="location.reload()">
                    üîÑ Try Again
                </button>
            {% else %}
                <p class="text-muted mb-3">Your playlists will sync automatically. Check back soon to see your library!</p>
                <div class="alert alert-info d-inline-block text-start" style="max-width: 500px;">
                    <h6>‚ÑπÔ∏è What happens automatically?</h6>
                    <ul class="mb-0 small">
                        <li>We fetch all your Spotify playlists</li>
                        <li>Import song information (titles, artists, albums)</li>
                        <li>Detect new songs and playlist changes</li>
                        <li>Keep your library up to date</li>
                    </ul>
                </div>
                {% if current_user.is_admin %}
                    <div class="mt-4">
                        <form action="{{ url_for('main.sync_playlists') }}" method="POST" class="d-inline" onsubmit="showSyncLoader()">
                            <button type="submit" class="btn btn-success btn-lg" id="syncButtonLarge">
                                <span id="syncButtonTextLarge">‚¨áÔ∏è Sync My Playlists</span>
                                <span id="syncButtonLoaderLarge" class="d-none">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                    Syncing playlists...
                                </span>
                            </button>
                        </form>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Toast container for notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="syncCompleteToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            ‚úÖ
            <strong class="me-auto">Playlist Sync</strong>
            <small class="text-muted">just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Playlist synchronization completed successfully!
        </div>
    </div>
</div>

<script>
// Show loading indicator when sync button clicked
async function showSyncLoader() {
    // Show spinner
    const btnText = document.getElementById('syncButtonText');
    const btnLoader = document.getElementById('syncButtonLoader');
    if (btnText) btnText.classList.add('d-none');
    if (btnLoader) btnLoader.classList.remove('d-none');
    
    const btnTextLarge = document.getElementById('syncButtonTextLarge');
    const btnLoaderLarge = document.getElementById('syncButtonLoaderLarge');
    if (btnTextLarge) btnTextLarge.classList.add('d-none');
    if (btnLoaderLarge) btnLoaderLarge.classList.remove('d-none');
    
    // Try to get playlist count for ETA
    try {
        const response = await fetch('/api/spotify/playlist-count', {credentials: 'same-origin'});
        if (response.ok) {
            const data = await response.json();
            const count = data.playlist_count || 0;
            const estimatedSeconds = count * 2; // ~2 seconds per playlist
            const minutes = Math.floor(estimatedSeconds / 60);
            const seconds = estimatedSeconds % 60;
            const eta = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            
            // Show toast with ETA
            const toastHtml = `
                <div class="toast align-items-center text-bg-info border-0 show" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            ‚è±Ô∏è Syncing ${count} playlists... Estimated time: ${eta}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', toastHtml);
        }
    } catch (e) {
        console.log('Could not fetch ETA:', e);
    }
    
    return true;
}

document.addEventListener('DOMContentLoaded', function () {
    // Async populate dashboard stats
    try {
        fetch('/api/dashboard/stats', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => {
                if (!d || d.success !== true || !d.totals) return;
                const t = d.totals;
                const elPlaylists = document.getElementById('totalPlaylists');
                const elAnalyzed = document.getElementById('totalAnalyzedSongs');
                const elPercent = document.getElementById('analysisPercentage');
                const elMini = document.getElementById('miniAnalysisProgress');
                const elClean = document.getElementById('cleanPlaylists');

                if (elPlaylists && typeof t.total_playlists === 'number') {
                    elPlaylists.textContent = t.total_playlists;
                    
                    // Update the total songs subtitle
                    const playlistsSubtitle = elPlaylists.parentElement.querySelector('.text-muted');
                    if (playlistsSubtitle && t.total_songs > 0) {
                        playlistsSubtitle.textContent = t.total_songs + ' total songs';
                    }
                }
                if (elAnalyzed && typeof t.analyzed_songs === 'number') {
                    elAnalyzed.textContent = t.analyzed_songs;
                    
                    // Update the subtitle text
                    const analyzedSubtitle = elAnalyzed.parentElement.querySelector('.text-muted');
                    if (analyzedSubtitle && t.total_songs > 0) {
                        analyzedSubtitle.innerHTML = `<span id="analysisPercentage">${t.analysis_progress.toFixed(1)}</span>% of total songs`;
                        
                        // Show the progress bar if it's hidden and add it if it doesn't exist
                        let progressContainer = elAnalyzed.parentElement.querySelector('.progress');
                        if (!progressContainer) {
                            progressContainer = document.createElement('div');
                            progressContainer.className = 'progress mt-2';
                            progressContainer.style.height = '8px';
                            progressContainer.innerHTML = '<div class="progress-bar bg-info" role="progressbar" id="miniAnalysisProgress"></div>';
                            analyzedSubtitle.parentElement.appendChild(progressContainer);
                        }
                        progressContainer.style.display = 'block';
                        
                        // Update the progress bar width
                        const progressBar = progressContainer.querySelector('.progress-bar');
                        if (progressBar) {
                            progressBar.style.width = t.analysis_progress + '%';
                        }
                    }
                }
                if (elPercent && typeof t.analysis_progress === 'number') elPercent.textContent = t.analysis_progress.toFixed(1) + '%';
                if (elMini && typeof t.analysis_progress === 'number') elMini.style.width = t.analysis_progress + '%';
                if (elClean && typeof t.clean_playlists === 'number') {
                    elClean.textContent = t.clean_playlists;
                    
                    // Update clean playlists percentage
                    const cleanPercentElement = elClean.parentElement.querySelector('.text-muted');
                    if (cleanPercentElement && t.total_playlists > 0) {
                        const cleanPct = ((t.clean_playlists / t.total_playlists) * 100).toFixed(1);
                        cleanPercentElement.textContent = cleanPct + '% of playlists';
                    }
                }
            })
            .catch(() => {});
    } catch(_) {}
    const searchInput = document.getElementById('playlistSearchInput');
    const scoreFilter = document.getElementById('scoreFilter');
    const playlistItems = document.querySelectorAll('.playlist-item');
    const syncButton = document.getElementById('syncButton');
    const syncMessage = document.getElementById('syncMessage');
    const syncProgress = document.getElementById('syncProgress');
    const lastChecked = document.getElementById('lastChecked');

    // Progress tracking variables
    let syncStartTime = null;
    let syncCheckInterval = null;
    let analysisCheckInterval = null;
    let reanalysisCheckInterval = null;
    let lastSyncProcessed = 0;

    function filterPlaylists() {
        const searchTerm = searchInput.value.toLowerCase();
        const scoreFilterValue = scoreFilter.value;

        playlistItems.forEach(function (item) {
            let showItem = true;

            // Search filter
            if (searchTerm) {
                const playlistName = item.getAttribute('data-name') || '';
                const playlistDescription = item.getAttribute('data-description') || '';

                if (!playlistName.includes(searchTerm) && !playlistDescription.includes(searchTerm)) {
                    showItem = false;
                }
            }

            // Score filter
            if (showItem && scoreFilterValue) {
                const score = item.getAttribute('data-score');
                const scoreValue = score === 'null' ? null : parseFloat(score);

                switch (scoreFilterValue) {
                    case 'high':
                        if (scoreValue === null || scoreValue < 75) showItem = false;
                        break;
                    case 'medium':
                        if (scoreValue === null || scoreValue < 50 || scoreValue >= 75) showItem = false;
                        break;
                    case 'low':
                        if (scoreValue === null || scoreValue >= 50) showItem = false;
                        break;
                    case 'unanalyzed':
                        if (scoreValue !== null) showItem = false;
                        break;
                }
            }

            item.style.display = showItem ? '' : 'none';
        });

        // Maintain sort order after filtering
        if (sortSelect && sortSelect.value) {
            sortPlaylists();
        }
    }

    function updateLastCheckedTime() {
        if (lastChecked) {
            const now = new Date();
            // Use user's local timezone with full date/time info
            const options = {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            lastChecked.textContent = now.toLocaleString(undefined, options);
        }
    }

    function formatTimestamps() {
        // Format last sync timestamp with user's timezone
        const lastSyncElement = document.getElementById('lastSync');
        if (lastSyncElement) {
            const timestamp = lastSyncElement.getAttribute('data-timestamp');
            if (timestamp) {
                const date = new Date(timestamp);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                };
                lastSyncElement.textContent = date.toLocaleString(undefined, options);
            }
        }

        // Format checked timestamp with user's timezone
        if (lastChecked) {
            const timestamp = lastChecked.getAttribute('data-timestamp');
            if (timestamp) {
                const date = new Date(timestamp);
                const options = {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                };
                lastChecked.textContent = date.toLocaleString(undefined, options);
            }
        }
    }

    function updateSyncProgress(elapsedSeconds, data = {}) {
        if (!syncProgress) return;

        // Enhanced progress calculation with real data
        let progressPercent = 25;
        let progressText = 'Initializing...';

        if (data.processed !== undefined && data.total !== undefined && data.total > 0) {
            progressPercent = Math.min((data.processed / data.total) * 100, 95);
            progressText = `Processing ${data.processed}/${data.total} playlists`;
        } else {
            // Fallback to time-based estimation
            progressPercent = Math.min(20 + (elapsedSeconds / 120) * 60, 90);

            if (elapsedSeconds < 30) {
                progressText = 'Initializing...';
            } else if (elapsedSeconds < 60) {
                progressText = 'Fetching playlists...';
            } else if (elapsedSeconds < 120) {
                progressText = 'Processing playlists...';
            } else {
                progressText = 'Finalizing...';
            }
        }

        syncProgress.style.width = progressPercent + '%';
        syncProgress.querySelector('.progress-text').textContent = progressText;

        // Update detailed sync stats
        updateSyncStats(elapsedSeconds, data);
    }

    function updateSyncStats(elapsedSeconds, data) {
        const processed = data.processed || 0;
        const total = data.total || 0;
        const remaining = Math.max(total - processed, 0);

        // Update counters
        document.getElementById('syncProcessed').textContent = processed;
        document.getElementById('syncRemaining').textContent = remaining > 0 ? remaining : '--';

        // Calculate and update rate
        if (processed > lastSyncProcessed && elapsedSeconds > 0) {
            const rate = ((processed - lastSyncProcessed) / (elapsedSeconds / 60)).toFixed(1);
            syncRateHistory.push(parseFloat(rate));
            if (syncRateHistory.length > 5) syncRateHistory.shift(); // Keep last 5 measurements

            const avgRate = syncRateHistory.reduce((a, b) => a + b, 0) / syncRateHistory.length;
            document.getElementById('syncRate').textContent = avgRate.toFixed(1) + '/min';

            // Calculate ETA
            if (avgRate > 0 && remaining > 0) {
                const etaMinutes = remaining / avgRate;
                let etaText;
                if (etaMinutes < 1) {
                    etaText = '<1 min';
                } else if (etaMinutes < 60) {
                    etaText = Math.ceil(etaMinutes) + ' min';
                } else {
                    const etaHours = Math.ceil(etaMinutes / 60);
                    etaText = etaHours + ' hr';
                }
                document.getElementById('syncETA').textContent = etaText;
            }
        }

        lastSyncProcessed = processed;

        // Update elapsed time
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        document.getElementById('syncElapsed').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // Old updateAnalysisProgress function removed - using unified updateAllProgressDisplays instead

    function checkAnalysisStatus() {
        // Only check background analysis status (simplified)
        fetch('/api/background-analysis/public-status', { credentials: 'same-origin' })
            .then(response => {
                if (!response.ok) {
                    return { success: false, active: false };
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success' && data.active === true) {
                    // Background analysis is running, show progress
                    const analysisAlert = document.getElementById('analysisProgressAlert');
                    if (analysisAlert) {
                        analysisAlert.style.display = 'block';
                    }
                    updateAllProgressDisplays(data);
                } else {
                    // No analysis running, hide progress indicators
                    hideAnalysisProgress();
                }
            })
            .catch(error => {
                console.error('Error checking analysis status:', error);
                hideAnalysisProgress();
            });
    }

    function showSyncCompleteToast() {
        const toastElement = document.getElementById('syncCompleteToast');
        if (toastElement) {
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    }

    function checkSyncStatus() {
        fetch('/api/sync-status', { credentials: 'same-origin' })
            .then(response => response.json())
            .then(data => {
                updateLastCheckedTime();

                if (!data.has_active_sync) {
                    // Sync is complete or not running
                    if (syncCheckInterval) {
                        clearInterval(syncCheckInterval);
                        syncCheckInterval = null;

                        // Hide auto-sync alert if it exists
                        const autoSyncAlert = document.getElementById('autoSyncAlert');
                        if (autoSyncAlert) {
                            autoSyncAlert.style.display = 'none';
                        }

                        // Show completion notification (regardless of completed count)
                        showSyncCompleteToast();

                        // Wait a moment then refresh to show new data
                        setTimeout(() => {
                            // Remove auto_sync_started session flag and refresh
                            fetch('{{ url_for("main.dashboard") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: 'clear_auto_sync=true',
                                credentials: 'same-origin'
                            }).then(() => {
                                location.reload();
                            }).catch(() => {
                                // Fallback - just reload
                                location.reload();
                            });
                        }, 1500);
                    }
                } else {
                    // Sync is still active - update progress
                    if (syncStartTime) {
                        const elapsedSeconds = Math.floor((Date.now() - syncStartTime) / 1000);
                        updateSyncProgress(elapsedSeconds, data);

                        // Update started time display
                        const syncStartedElement = document.getElementById('syncStarted');
                        if (syncStartedElement) {
                            if (elapsedSeconds < 60) {
                                syncStartedElement.textContent = `${elapsedSeconds}s ago`;
                            } else {
                                const minutes = Math.floor(elapsedSeconds / 60);
                                syncStartedElement.textContent = `${minutes}m ago`;
                            }
                        }

                        // Update auto-sync progress bar if present
                        const autoSyncProgress = document.getElementById('autoSyncProgress');
                        if (autoSyncProgress) {
                            const autoProgressPercent = Math.min(30 + (elapsedSeconds / 180) * 50, 85);
                            autoSyncProgress.style.width = autoProgressPercent + '%';

                            if (elapsedSeconds < 45) {
                                autoSyncProgress.querySelector('small').textContent = 'Connecting to Spotify...';
                            } else if (elapsedSeconds < 90) {
                                autoSyncProgress.querySelector('small').textContent = 'Discovering your playlists...';
                            } else if (elapsedSeconds < 150) {
                                autoSyncProgress.querySelector('small').textContent = 'Processing playlist data...';
                            } else {
                                autoSyncProgress.querySelector('small').textContent = 'Almost done...';
                            }
                        }
                    }

                    // Update sync message with job details if available
                    if (data.jobs && data.jobs.active && data.jobs.active.length > 0) {
                        const activeJob = data.jobs.active[0];
                        const syncMessageEl = document.getElementById('syncMessage');
                        if (syncMessageEl && activeJob.meta) {
                            const meta = activeJob.meta;
                            if (meta.current_attempt && meta.max_attempts) {
                                syncMessageEl.textContent = `Processing playlists... (attempt ${meta.current_attempt}/${meta.max_attempts})`;
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error checking sync status:', error);
                updateLastCheckedTime();

                // If we're monitoring and there's an error, retry in a few seconds
                if (syncCheckInterval) {
                    // Don't spam errors, just continue monitoring
                }
            });
    }

    if (searchInput) {
        searchInput.addEventListener('keyup', filterPlaylists);
    }

    if (scoreFilter) {
        scoreFilter.addEventListener('change', filterPlaylists);
    }

    // Add sort functionality
    const sortSelect = document.getElementById('sortSelect');
    if (sortSelect) {
        sortSelect.addEventListener('change', sortPlaylists);
    }

    function sortPlaylists() {
        const sortValue = sortSelect.value;
        const playlistGrid = document.getElementById('playlistGrid');
        const playlistItems = Array.from(playlistGrid.children);

        playlistItems.sort((a, b) => {
            switch (sortValue) {
                case 'name-asc':
                    return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
                case 'name-desc':
                    return b.getAttribute('data-name').localeCompare(a.getAttribute('data-name'));
                case 'score-desc':
                    const scoreA = parseFloat(a.getAttribute('data-score')) || -1;
                    const scoreB = parseFloat(b.getAttribute('data-score')) || -1;
                    return scoreB - scoreA;
                case 'score-asc':
                    const scoreA2 = parseFloat(a.getAttribute('data-score')) || 101;
                    const scoreB2 = parseFloat(b.getAttribute('data-score')) || 101;
                    return scoreA2 - scoreB2;
                case 'tracks-desc':
                    const tracksA = parseInt(a.getAttribute('data-tracks')) || 0;
                    const tracksB = parseInt(b.getAttribute('data-tracks')) || 0;
                    return tracksB - tracksA;
                case 'tracks-asc':
                    const tracksA2 = parseInt(a.getAttribute('data-tracks')) || 0;
                    const tracksB2 = parseInt(b.getAttribute('data-tracks')) || 0;
                    return tracksA2 - tracksB2;
                default:
                    return 0;
            }
        });

        // Clear and re-append sorted items
        playlistGrid.innerHTML = '';
        playlistItems.forEach(item => playlistGrid.appendChild(item));
    }

    // Auto-refresh when sync is complete
    {% if sync_status and sync_status.has_active_sync %}
    syncStartTime = Date.now();
    {% elif session.auto_sync_started %}
    // Auto-sync was started, begin monitoring
    syncStartTime = Date.now();
    {% endif %}

    // Start monitoring if sync is active or was just started
    {% if sync_status and sync_status.has_active_sync or session.auto_sync_started %}
    // Check sync status every 2 seconds for more responsive feedback
    syncCheckInterval = setInterval(checkSyncStatus, 2000);

    // Initial progress update
    updateSyncProgress(0);
    {% endif %}

    // Initial status checks - simplified to only check background analysis
    // Old system disabled - using unified progress polling

    // Clean up intervals when page is unloaded
    window.addEventListener('beforeunload', function() {
        if (syncCheckInterval) {
            clearInterval(syncCheckInterval);
        }
        // analysisCheckInterval disabled - using unified progress polling
        // if (analysisCheckInterval) {
        //     clearInterval(analysisCheckInterval);
        // }
        if (reanalysisCheckInterval) {
            clearInterval(reanalysisCheckInterval);
        }
        if (progressPoller) {
            clearInterval(progressPoller);
        }
    });

    // Update checked time immediately
    updateLastCheckedTime();

    // Format timestamps on page load
    formatTimestamps();
});

// Progress tracking functionality
let progressPoller = null;
let currentJobId = null;

document.addEventListener('DOMContentLoaded', function() {
    const startAnalysisBtn = document.getElementById('start-analysis-btn');
    if (startAnalysisBtn) {
        startAnalysisBtn.addEventListener('click', startBackgroundAnalysis);
    }

    // Check for existing analysis jobs on page load
    checkExistingAnalysis();
});

async function checkExistingAnalysis() {
    try {
        const response = await fetch('/api/background-analysis/public-status');
        const data = await response.json();

        if (data.status === 'success') {
            currentJobId = data.job_id;

            // Always update displays with current data (this handles both active and completed jobs)
            updateAllProgressDisplays(data);

            // Only start polling if analysis is still active
            if (data.active === true) {
                showAnalysisProgress();
                startProgressPolling();
                console.log('Found active background analysis job:', data.job_id);
                console.log('ETA:', data.estimated_hours, 'hours');
            } else {
                console.log('Found completed background analysis job:', data.job_id);
            }
        } else {
            // No analysis found at all
            hideAnalysisProgress();
            console.log('No background analysis found');
        }
    } catch (error) {
        console.error('Error checking existing analysis:', error);
        hideAnalysisProgress();
    }
}

function updateAllProgressDisplays(data) {
    console.log(`üîÑ updateAllProgressDisplays called with data:`, data);

    if (!data) {
        console.log(`‚èπÔ∏è No data provided, hiding progress displays`);
        hideAnalysisProgress();
        return;
    }

    const completed = data.analyzed_songs || 0;
    const total = data.total_songs || 0;
    const failed = data.failed_songs || 0;
    const percentage = data.percentage || (total > 0 ? Math.min(100, Math.round((completed / total) * 100)) : 0);
    const remaining = data.remaining_songs || Math.max(0, total - completed - failed);

    // Check if analysis is actually complete (negative ETA or completed >= total)
    const isComplete = (data.estimated_hours && data.estimated_hours < 0) || (completed >= total);

    console.log(`üîÑ UNIFIED PROGRESS UPDATE: ${completed}/${total} (${percentage}%) - ${remaining} remaining - Complete: ${isComplete}`);

    // If analysis is complete, hide the progress alert but still update the cards
    if (isComplete) {
        console.log(`‚úÖ Analysis COMPLETE! Hiding progress alert and updating final stats`);
        hideAnalysisProgress();
        // GA4 conversion: analysis completed (send once)
        if (typeof window.gtag === 'function' && !window._ga_analysis_completed_sent) {
            window.gtag('event', 'analyze_completed', {
                event_category: 'analysis',
                completed_songs: completed,
                total_songs: total
            });
            window._ga_analysis_completed_sent = true;
        }
        // Server-side GA4 (best-effort)
        try {
            fetch('/api/ga4/analyze-completed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed_songs: completed, total_songs: total })
            }).catch(() => {});
        } catch (_) {}
        // Continue to update the Songs Analyzed card with final numbers
    }

    // ===== 1. UPDATE MAIN ANALYSIS PROGRESS ALERT =====
    const progressBar = document.getElementById('analysisProgress');
    const progressText = document.querySelector('#analysisProgress .progress-text');
    const messageElement = document.getElementById('analysisMessage');
    const completedElement = document.getElementById('analysisCompleted');
    const pendingElement = document.getElementById('analysisPending');
    const etaElement = document.getElementById('analysisETA');

    // Update main progress bar
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        console.log(`‚úÖ Updated main progress bar: ${percentage}%`);
    }
    if (progressText) {
        progressText.textContent = `${completed}/${total} songs analyzed (${percentage}%)`;
        console.log(`‚úÖ Updated progress text: ${completed}/${total} (${percentage}%)`);
    }

    // Update message with current song info
    if (messageElement && data.message) {
        messageElement.textContent = data.message;
    }

    // Update counters
    if (completedElement) {
        completedElement.textContent = completed;
        console.log(`‚úÖ Updated completed counter: ${completed}`);
    }
    if (pendingElement) {
        pendingElement.textContent = remaining;
    }

    // Update ETA
    if (etaElement && data.estimated_hours) {
        const hours = Math.round(data.estimated_hours * 10) / 10; // Round to 1 decimal
        etaElement.textContent = hours > 0 ? `${hours}h` : 'calculating...';
    }

    // Update current job description with real data
    const currentJobElement = document.getElementById('currentJob');
    if (currentJobElement) {
        const userName = data.user_name || '{{ current_user.display_name }}';
        if (data.estimated_hours && data.processing_rate) {
            const hours = Math.round(data.estimated_hours * 10) / 10;
            const rate = Math.round(data.processing_rate);
            currentJobElement.textContent = `Background analysis for ${userName} (ETA: ${hours}h) ‚Ä¢ ${rate}/hr`;
        } else {
            currentJobElement.textContent = `Background analysis for ${userName}`;
        }
    }

    // ===== 2. UPDATE SONGS ANALYZED CARD (ONLY DURING ACTIVE ANALYSIS) =====
    // Only update dashboard stats if there's actually an active analysis running
    // Otherwise, let the dashboard stats API update handle the final counts
    if (data && data.active === true && (completed > 0 || total > 0)) {
        const totalAnalyzedSongsElement = document.getElementById('totalAnalyzedSongs');
        const analysisPercentageElement = document.getElementById('analysisPercentage');
        const miniProgressBar = document.getElementById('miniAnalysisProgress');

        // Update the songs analyzed count (silent if element missing)
        if (totalAnalyzedSongsElement) {
            const oldValue = totalAnalyzedSongsElement.textContent;
            totalAnalyzedSongsElement.textContent = completed;
            console.log(`‚úÖ Songs Analyzed Card: Updated count from ${oldValue} to ${completed}`);
        }

        // Update the percentage text (silent if element missing)
        if (analysisPercentageElement) {
            const oldValue = analysisPercentageElement.textContent || '';
            analysisPercentageElement.textContent = `${percentage.toFixed(1)}%`;
            console.log(`‚úÖ Songs Analyzed Card: Updated percentage from ${oldValue} to ${percentage.toFixed(1)}%`);
        }

        // Update the mini progress bar (silent if element missing)
        if (miniProgressBar) {
            const oldWidth = miniProgressBar.style.width || '';
            miniProgressBar.style.width = `${percentage}%`;
            console.log(`‚úÖ Songs Analyzed Card: Updated mini progress bar from ${oldWidth} to ${percentage}%`);
        }
    } else {
        console.log(`‚è≠Ô∏è Skipping Songs Analyzed card update (no active analysis or completed=${completed}, total=${total})`);
    }

    console.log(`üéØ UNIFIED PROGRESS UPDATE COMPLETE: All displays now show ${completed}/${total} (${percentage}%)`);
}

async function startProgressPolling() {
    const pollInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/analysis/progress');
            const data = await response.json();

            if (data.success) {
                updateAllProgressDisplays(data);

                // Stop polling if analysis is complete
                if (data.is_complete || data.remaining_songs === 0) {
                    console.log('‚úÖ Analysis complete, stopping progress polling');
                    clearInterval(pollInterval);
                    hideAnalysisProgress();
                    
                    // Show completion message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        ‚úÖ
                        <strong>Analysis Complete!</strong> Analyzed ${data.analyzed_songs} songs total${data.failed_songs > 0 ? ` (${data.failed_songs} failed)` : ''}.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    const container = document.querySelector('.container.py-4');
                    if (container) {
                        container.insertBefore(alertDiv, container.firstChild);
                    }
                    
                    // Refresh the page after a delay to show updated stats
                    setTimeout(() => location.reload(), 3000);
                }
            }
        } catch (error) {
            console.error('Progress polling error:', error);
        }
    }, 3000);
}

function showAnalysisProgress() {
    console.log('üé¨ showAnalysisProgress: Showing analysis progress and hiding analyze banners');

    // Show the main analysis progress alert
    const analysisAlert = document.getElementById('analysisProgressAlert');
    if (analysisAlert) {
        analysisAlert.style.display = 'block';
        console.log('‚úÖ Showed main analysis progress alert');
    }

    // Hide the "unanalyzed songs" template banner
    const unanalyzedAlert = document.getElementById('unanalyzedSongsAlert');
    if (unanalyzedAlert) {
        unanalyzedAlert.style.display = 'none';
        console.log('‚úÖ Hidden unanalyzed songs template banner');
    }

    // Hide flash messages containing "unanalyzed songs"
    const flashMessages = document.getElementById('flashMessages');
    if (flashMessages) {
        const alerts = flashMessages.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.textContent.includes('unanalyzed songs')) {
                alert.style.display = 'none';
                console.log('‚úÖ Hidden flash message about unanalyzed songs');
            }
        });
    }

    // Hide the start button
    const startBtn = document.getElementById('start-analysis-btn');
    if (startBtn) {
        startBtn.style.display = 'none';
        console.log('‚úÖ Hidden start analysis button');
    }
}

function hideAnalysisProgress() {
    console.log('üé≠ hideAnalysisProgress: Hiding analysis progress and showing analyze banners');

    // Hide the main analysis progress alert
    const analysisAlert = document.getElementById('analysisProgressAlert');
    if (analysisAlert) {
        analysisAlert.style.display = 'none';
        console.log('‚úÖ Hidden main analysis progress alert');
    }

    // Show the "unanalyzed songs" template banner (if there are still unanalyzed songs)
    const unanalyzedAlert = document.getElementById('unanalyzedSongsAlert');
    if (unanalyzedAlert) {
        unanalyzedAlert.style.display = 'block';
        console.log('‚úÖ Showed unanalyzed songs template banner');
    }

    // Show flash messages containing "unanalyzed songs"
    const flashMessages = document.getElementById('flashMessages');
    if (flashMessages) {
        const alerts = flashMessages.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.textContent.includes('unanalyzed songs') && alert.style.display === 'none') {
                alert.style.display = 'block';
                console.log('‚úÖ Showed flash message about unanalyzed songs');
            }
        });
    }

    // Show and reset the start button
    const startBtn = document.getElementById('start-analysis-btn');
    if (startBtn) {
        startBtn.style.display = 'inline-block';
        startBtn.disabled = false;
        startBtn.innerHTML = '‚ñ∂Ô∏è Analyze All';
        console.log('‚úÖ Showed and reset start analysis button');
    }
}

async function startBackgroundAnalysis() {
    const btn = document.getElementById('start-analysis-btn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Starting...';

    try {
        const response = await fetch('/api/analysis/start-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (data.success) {
            if (data.total_songs === 0 || data.songs_analyzed === data.total_songs) {
                // All songs are already analyzed
                btn.innerHTML = '‚úÖ All Songs Analyzed';
                btn.disabled = true;

                // Show a brief success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    ‚úÖ
                    <strong>Analysis Complete!</strong> ${data.message || 'All songs have been analyzed.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // Insert after the analyze button
                btn.parentNode.insertBefore(alertDiv, btn.nextSibling);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);

            } else {
                // Analysis started successfully
                showAnalysisProgress();
                startProgressPolling();
                console.log(`‚úÖ Started analysis: ${data.songs_analyzed} songs analyzed, ${data.songs_failed} failed out of ${data.total_songs} total`);
            }
        } else {
            throw new Error(data.error || 'Failed to start analysis');
        }
    } catch (error) {
        console.error('Error starting analysis:', error);
        alert('Failed to start analysis: ' + (error.message || 'Unknown error'));
        btn.disabled = false;
        btn.innerHTML = '‚ñ∂Ô∏è Analyze All';
    }
}

// Modal functions for auto-sync analysis confirmation
async function startAnalysisFromModal() {
    console.log('Starting analysis from modal confirmation...');
    
    // Hide the modal
    const modal = document.getElementById('analysisModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Clear the session flag
    await fetch('/api/clear-analysis-modal', { method: 'POST' });
    
    // Trigger the analysis
    await startBackgroundAnalysis();
}

async function dismissAnalysisModal() {
    console.log('Dismissing analysis modal...');
    
    // Hide the modal
    const modal = document.getElementById('analysisModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Clear the session flag
    await fetch('/api/clear-analysis-modal', { method: 'POST' });
}
</script>

<!-- Load main.js for modular functionality -->
<script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

{% endblock %}

<style>
/* Enhanced Progress Indicator Styles - Using Modern Design System */
.sync-stat, .analysis-stat {
    background-color: var(--light-bg);
    border-radius: var(--border-radius-sm);
    padding: 12px 8px;
    margin-bottom: 8px;
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.sync-stat:hover, .analysis-stat:hover {
    background-color: var(--hover-bg);
    border-color: rgba(107, 70, 193, 0.2);
}

.sync-number, .analysis-number {
    font-size: 1.4rem;
    font-weight: 700;
    display: block;
    line-height: 1.2;
    color: var(--primary-purple);
}

.sync-label, .analysis-label {
    font-size: 0.75rem;
    color: var(--muted-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 2px;
    font-weight: 500;
}

.progress-text {
    font-size: 0.85rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    font-weight: 500;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .sync-stat, .analysis-stat {
        padding: 8px 4px;
        margin-bottom: 6px;
    }

    .sync-number, .analysis-number {
        font-size: 1.2rem;
    }

    .sync-label, .analysis-label {
        font-size: 0.7rem;
    }

    .progress-text {
        font-size: 0.8rem;
    }
}

/* Animation for progress bars */
.progress-bar {
    transition: width 0.3s ease-in-out;
}

/* Pulse animation for analysis icon */
.fa-pulse {
    animation: fa-pulse 2s infinite;
}

@keyframes fa-pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>

<!-- Progress indicators are now integrated directly in the dashboard -->
