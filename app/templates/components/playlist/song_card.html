{#
Song Card Component for Playlist Grid View (card-only default)
Expected vars: item (with song, analysis or analysis_result), playlist
#}

{% set analysis = item.analysis_result if item.analysis_result is defined and item.analysis_result else item.analysis %}

<div class="col-12 col-sm-6 col-lg-3 mb-4">
    <div class="card h-100 song-card" data-song-id="{{ item.song.id }}">
        <div class="position-relative">
            <img src="{{ item.song.album_art_url or url_for('static', filename='images/default_album_art.png') }}"
                 class="card-img-top" alt="{{ item.song.title }} album art" loading="lazy"
                 style="width: 100% !important; height: 200px !important; object-fit: cover !important;">
        </div>

        <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-start justify-content-between mb-1">
                <h6 class="card-title mb-0 pe-2 flex-grow-1">
                    <a href="{{ url_for('main.song_detail', song_id=item.song.id, playlist_id=playlist['id']) }}" class="text-decoration-none song-title-link">
                        {{ item.song.title }}
                    </a>
                </h6>
                {% if analysis and analysis.score is not none %}
                {% set s = analysis.score|float %}
                <span class="score-circle ms-2 {% if s >= 75 %}score-green{% elif s >= 50 %}score-yellow{% else %}score-red{% endif %}">{{ "%.0f"|format(s) }}%</span>
                {% endif %}
            </div>
            <p class="card-text text-muted small mb-1">{{ item.song.artist }}</p>
            <p class="card-text text-muted small">{{ item.song.album or 'Unknown Album' }}</p>

            {% if analysis and analysis.score is not none %}
                <small class="text-muted mb-2">{{ analysis.concern_level|default('Unknown')|title }}</small>
                {% set reason = analysis.explanation or (analysis.concerns[0] if analysis.concerns) %}
                {% if reason %}
                <div class="text-muted small reason-snippet" title="{{ reason }}">Reason: {{ reason }}</div>
                {% endif %}
            {% else %}
                <small class="text-muted mb-2">Not Analyzed</small>
            {% endif %}

            <div class="mt-auto d-grid gap-2">
                {% set is_admin = current_user.is_authenticated and (current_user.is_admin if current_user.is_admin is defined else False) %}
                {% if not analysis %}
                    {% if is_admin %}
                    <button class="btn btn-sm btn-primary fw-bold analyze-song-btn w-100"
                            data-song-id="{{ item.song.id }}"
                            data-song-title="{{ item.song.title }}"
                            data-song-artist="{{ item.song.artist }}">
                        Analyze
                    </button>
                    {% endif %}
                {% else %}
                    {% set s = analysis.score|float if analysis.score is not none else None %}
                    {% if s is not none and s < 75 %}
                        <a href="{{ url_for('main.song_detail', song_id=item.song.id, playlist_id=playlist['id']) }}" class="btn btn-sm btn-warning fw-bold w-100">Review</a>
                    {% endif %}
                    {% if is_admin %}
                    <button class="btn btn-sm btn-outline-secondary analyze-song-btn w-100"
                            data-song-id="{{ item.song.id }}"
                            data-song-title="{{ item.song.title }}"
                            data-song-artist="{{ item.song.artist }}">Re-analyze</button>
                    {% endif %}
                {% endif %}

                <!-- Remove from Playlist (always available) -->
                <form method="post" action="{{ url_for('main.remove_from_playlist', playlist_id=playlist['id'], song_id=item.song.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger w-100"
                            onclick="return confirm('Remove this song from the playlist? This action cannot be undone.')">
                        <i class="fas fa-trash me-2"></i>Remove from Playlist
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
