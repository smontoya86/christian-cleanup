{% extends "base.html" %}

{% block title %}{% if song %}{{ song.title }}{% else %}Song Details{% endif %} - {{ super() }}{% endblock %}

{% block content %}
<div class="container py-4">
    {% if song %}
        <!-- Song Header -->
        <div class="row mb-4 align-items-center">
            <div class="col-md-2 text-center text-md-start mb-3 mb-md-0">
                {% if song.album_art_url %}
                    <img src="{{ song.album_art_url }}" alt="{{ song.title }} album art" class="rounded shadow-sm"
                     style="width: 150px !important; height: 150px !important; object-fit: cover !important;">
                {% else %}
                    <div class="bg-light d-flex align-items-center justify-content-center rounded shadow-sm" style="width: 150px; height: 150px;">
                        <i class="fas fa-music text-muted fa-4x"></i>
                    </div>
                {% endif %}
            </div>
            <div class="col-md-10">
                <h1 class="display-6">{{ song.title }}</h1>
                <p class="lead text-muted mb-1">By {{ song.artist }}</p>
                <p class="text-muted"><small>Album: {{ song.album }}</small></p>

                <!-- Quick Score Display -->
                {% if analysis and analysis.score is not none %}
                    <div class="mt-3">
                        {% set score = analysis.score if analysis.score > 1 else (analysis.score * 100) %}
                        {% set concern_level = analysis.concern_level if analysis and analysis.concern_level and analysis.concern_level != 'unknown' else ('very_low' if score >= 90 else ('low' if score >= 75 else ('medium' if score >= 50 else 'high'))) %}

                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <!-- Score Circle - Always visible -->
                            <div class="score-circle {% if score >= 85 %}score-good{% elif score >= 60 %}score-medium{% elif score >= 40 %}score-caution{% else %}score-avoid{% endif %}"
                                 data-bs-toggle="tooltip" 
                                 data-bs-placement="top"
                                 title="Biblical alignment score (0-100). Higher scores indicate stronger spiritual formation alignment.">
                                {{ "%.0f" | format(score) }}
                            </div>
                            <div>
                                <div class="fw-bold fs-5">
                                    {% if analysis.verdict %}
                                        {% if analysis.verdict == 'freely_listen' %}
                                            <span data-bs-toggle="tooltip" title="85-100: Biblically sound, theologically clear, spiritually edifying">‚úÖ Freely Listen</span>
                                        {% elif analysis.verdict == 'context_required' %}
                                            <span data-bs-toggle="tooltip" title="60-84: Helpful content with some discernment needed. Consider context and maturity.">ü§î Context Required</span>
                                        {% elif analysis.verdict == 'caution_limit' %}
                                            <span data-bs-toggle="tooltip" title="40-59: More concerns than positive content. Use with strong discernment.">‚ö†Ô∏è Caution Limit</span>
                                        {% elif analysis.verdict == 'avoid_formation' %}
                                            <span data-bs-toggle="tooltip" title="0-39: Harmful to spiritual formation. May undermine biblical principles.">‚ùå Avoid Formation</span>
                                        {% else %}
                                            {{ analysis.verdict | replace('_', ' ') | title }}
                                        {% endif %}
                                    {% elif concern_level in ['very_low', 'low'] %}
                                        <span data-bs-toggle="tooltip" title="Minimal spiritual concerns detected">‚úÖ Great Choice</span>
                                    {% elif concern_level == 'medium' %}
                                        <span data-bs-toggle="tooltip" title="Some spiritual concerns present. Use discernment.">‚ö†Ô∏è Use Discretion</span>
                                    {% else %}
                                        <span data-bs-toggle="tooltip" title="Significant spiritual concerns detected">‚ùå High Concern</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    <span data-bs-toggle="tooltip" title="Based on Christian Framework v3.1 using GPT-4o-mini fine-tuned model">Purity Score: {{ "%.0f" | format(score) }}%</span>
                                    {% if analysis.confidence %}
                                        ‚Ä¢ Confidence: {{ analysis.confidence | title }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="row g-4">
            <!-- Left Column: Analysis Summary -->
            <div class="col-lg-8">
                {% if analysis %}
                    <!-- Summary Card -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Analysis Summary</h5>
                        </div>
                        <div class="card-body">
                            {% if analysis.explanation %}
                                {% set explanation = analysis.explanation %}

                                <!-- Clean up and simplify the explanation -->
                                {% set clean_explanation = explanation | replace('This song demonstrates', 'This song shows') | replace('discernment score', 'purity score') | replace('Key themes identified include:', 'Main themes:') %}

                                <!-- Extract the main summary -->
                                {% set summary_parts = clean_explanation.split('Key themes identified') %}
                                {% if summary_parts[0] %}
                                    {% set summary = summary_parts[0].strip().rstrip('.') %}
                                    <!-- Make it more conversational -->
                                    {% set friendly_summary = summary | replace('demonstrates positive sentiment', 'has positive content') | replace('with a discernment score', 'with a purity score') %}
                                    <div class="mb-3">
                                        <p class="lead">{{ friendly_summary }}.</p>
                                    </div>
                                {% endif %}

                                <!-- Extract and simplify concerns -->
                                {% if 'area(s) requiring discernment:' in explanation %}
                                    {% set concern_part = explanation.split('area(s) requiring discernment:')[1].split('.')[0] %}
                                    {% set clean_concerns = concern_part.strip() | replace('Pride and Self-Focus', 'Pride/Self-Focus') | replace('Language and Expression', 'Language') | replace('Rebellion Against Authority', 'Rebellion') | replace('Occult and Spiritual Darkness', 'Spiritual Concerns') %}
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Things to Consider</h6>
                                        <p class="mb-0">{{ clean_concerns }}</p>
                                    </div>
                                {% elif 'high concern level' in explanation.lower() %}
                                    <div class="alert alert-danger">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>High Concern Content</h6>
                                        <p class="mb-0">This song contains content that may not align with Christian values. Review carefully.</p>
                                    </div>
                                {% endif %}

                                <!-- Add helpful guidance -->
                                {% if analysis.score %}
                                    {% set score = analysis.score if analysis.score > 1 else (analysis.score * 100) %}
                                    {% set has_concerns = (analysis.concerns and (analysis.concerns | length > 0)) or (analysis.purity_flags_details and (analysis.purity_flags_details | length > 0)) %}
                                    {% if score >= 85 %}
                                        <div class="alert alert-success">
                                            <h6><i class="fas fa-check-circle me-2"></i>Great for Christian Listening</h6>
                                            <p class="mb-0">This song aligns well with biblical values and supports spiritual growth.</p>
                                        </div>
                                    {% elif score >= 70 %}
                                        <div class="alert alert-info">
                                            <h6><i class="fas fa-info-circle me-2"></i>Generally Good Choice</h6>
                                            {% if has_concerns %}
                                                <p class="mb-0">This song is mostly appropriate with only minor concerns to consider.</p>
                                            {% else %}
                                                <p class="mb-0">This song is mostly appropriate. No specific concerns were identified.</p>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <p class="text-muted">Analysis data is available but no detailed explanation was provided.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Concerns & Positive Themes -->
                    <div class="row g-3 mb-4">
                        <!-- Concerns -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-exclamation-circle me-2"></i>Concerns Found
                                        {% if analysis.concerns %}
                                            {% set concerns_data = analysis.concerns %}
                                            {% if concerns_data is string %}
                                                {% set concerns_data = concerns_data | from_json %}
                                            {% endif %}
                                            {% if concerns_data and (concerns_data | length > 0) %}
                                                <span class="badge bg-dark ms-2">{{ concerns_data | length }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if analysis.concerns %}
                                        {% set concerns_data = analysis.concerns %}
                                        {% if concerns_data is string %}
                                            {% set concerns_data = concerns_data | from_json %}
                                        {% endif %}
                                        {% if concerns_data and (concerns_data | length > 0) %}
                                            {% for concern in concerns_data %}
                                                <div class="mb-2 p-2 border-start border-warning border-3 bg-light">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <span class="badge bg-warning text-dark">
                                                            {{ (concern.category if concern.category else (concern.type if concern.type else 'Content Issue')) | replace('_', ' ') | title }}
                                                        </span>
                                                        {% if concern.severity %}
                                                            <small class="badge bg-secondary">{{ concern.severity.title() }}</small>
                                                        {% endif %}
                                                    </div>
                                                    {% if concern.explanation %}
                                                        <p class="mb-0 mt-1 small text-muted">{{ concern.explanation }}</p>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <span class="fw-semibold">No major concerns identified</span>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="text-success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <span class="fw-semibold">No major concerns identified</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Positive Themes -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-heart me-2"></i>Positive Themes
                                        {% if (analysis.positive_themes_identified and (analysis.positive_themes_identified | length > 0)) or (analysis.biblical_themes and (analysis.biblical_themes | length > 0)) %}
                                            <span class="badge bg-dark ms-2">
                                                {{ (analysis.positive_themes_identified | length) if analysis.positive_themes_identified else (analysis.biblical_themes | length) }}
                                            </span>
                                        {% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if analysis.positive_themes_identified and (analysis.positive_themes_identified | length > 0) %}
                                        {% for theme in analysis.positive_themes_identified %}
                                            <div class="mb-2 p-2 border-start border-success border-3 bg-light">
                                                <span class="badge bg-success">
                                                    {{ (theme.theme if theme.theme else 'Positive Content') | title }}
                                                </span>
                                                {% if theme.description %}
                                                    <p class="mb-0 mt-1 small text-muted">{{ theme.description }}</p>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% elif analysis.biblical_themes and (analysis.biblical_themes | length > 0) %}
                                        {% for theme in analysis.biblical_themes %}
                                            <div class="mb-2 p-2 border-start border-success border-3 bg-light">
                                                <span class="badge bg-success">
                                                    {{ (theme.theme if theme.theme else 'Biblical Theme') | title }}
                                                </span>
                                                {% if theme.points %}
                                                    <small class="text-muted ms-2">+{{ theme.points }} points</small>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted fst-italic">
                                            <i class="fas fa-info-circle me-2"></i>
                                            No specific positive themes identified
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- General Themes & Analysis Metadata -->
                    {% if analysis.themes or analysis.formation_risk or analysis.doctrinal_clarity or analysis.narrative_voice %}
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Additional Analysis Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- General Themes -->
                                    {% if analysis.themes %}
                                        <div class="col-12">
                                            <h6 class="text-secondary mb-2">Themes Identified:</h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                {% set themes_data = analysis.themes %}
                                                {% if themes_data is string %}
                                                    {% set themes_data = themes_data | from_json %}
                                                {% endif %}
                                                {% if themes_data and (themes_data | length > 0) %}
                                                    {% for theme in themes_data %}
                                                        <span class="badge bg-secondary">
                                                            {{ (theme.theme if theme.theme else theme) | title }}
                                                        </span>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Formation Risk -->
                                    {% if analysis.formation_risk %}
                                        <div class="col-md-6">
                                            <div class="p-3 border rounded {% if analysis.formation_risk in ['high', 'extreme'] %}border-danger bg-danger bg-opacity-10{% elif analysis.formation_risk == 'medium' %}border-warning bg-warning bg-opacity-10{% else %}border-success bg-success bg-opacity-10{% endif %}">
                                                <small class="text-muted d-block mb-1">Formation Risk:</small>
                                                <strong class="{% if analysis.formation_risk in ['high', 'extreme'] %}text-danger{% elif analysis.formation_risk == 'medium' %}text-warning{% else %}text-success{% endif %}">
                                                    {{ analysis.formation_risk | title }}
                                                </strong>
                                                <small class="d-block mt-1 text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    {% if analysis.formation_risk in ['high', 'extreme'] %}
                                                        May negatively impact spiritual growth
                                                    {% elif analysis.formation_risk == 'medium' %}
                                                        Use discernment regarding spiritual impact
                                                    {% else %}
                                                        Minimal impact on spiritual formation
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Doctrinal Clarity -->
                                    {% if analysis.doctrinal_clarity %}
                                        <div class="col-md-6">
                                            <div class="p-3 border rounded {% if analysis.doctrinal_clarity == 'high' %}border-success bg-success bg-opacity-10{% elif analysis.doctrinal_clarity == 'medium' %}border-warning bg-warning bg-opacity-10{% else %}border-info bg-info bg-opacity-10{% endif %}">
                                                <small class="text-muted d-block mb-1">Doctrinal Clarity:</small>
                                                <strong class="{% if analysis.doctrinal_clarity == 'high' %}text-success{% elif analysis.doctrinal_clarity == 'medium' %}text-warning{% else %}text-info{% endif %}">
                                                    {{ analysis.doctrinal_clarity | title }}
                                                </strong>
                                                <small class="d-block mt-1 text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    {% if analysis.doctrinal_clarity == 'high' %}
                                                        Clear biblical teaching
                                                    {% elif analysis.doctrinal_clarity == 'medium' %}
                                                        Some biblical principles present
                                                    {% else %}
                                                        Limited doctrinal content
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Narrative Voice -->
                                    {% if analysis.narrative_voice %}
                                        <div class="col-12">
                                            <div class="p-3 border rounded border-info bg-info bg-opacity-10">
                                                <small class="text-muted d-block mb-1">Narrative Perspective:</small>
                                                <strong class="text-info">{{ analysis.narrative_voice | replace('_', ' ') | title }}</strong>
                                                {% if analysis.lament_filter_applied %}
                                                    <span class="badge bg-info ms-2">Lament Context</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Analysis Quality Indicator -->
                                    {% if analysis.analysis_quality and analysis.analysis_quality != 'full' %}
                                        <div class="col-12">
                                            <div class="alert alert-info mb-0">
                                                <small>
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Analysis Note:</strong>
                                                    {% if analysis.analysis_quality == 'degraded' %}
                                                        This analysis was performed with limited data.
                                                    {% elif analysis.analysis_quality == 'cached' %}
                                                        This is a cached analysis result.
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Needs Review Flag -->
                                    {% if analysis.needs_review %}
                                        <div class="col-12">
                                            <div class="alert alert-warning mb-0">
                                                <small>
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    <strong>Review Recommended:</strong> This analysis has been flagged for additional human review due to complex content.
                                                </small>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Biblical Content (if any) -->
                    {% if analysis.biblical_themes or analysis.supporting_scripture %}
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-bible me-2"></i>Biblical Analysis</h5>
                            </div>
                            <div class="card-body">

                                {% if analysis.supporting_scripture %}
                    <!-- Categorized Scripture References -->
                    {% if analysis.supporting_scripture is iterable and analysis.supporting_scripture is not string %}
                        {% set positive_scriptures = [] %}
                        {% set concern_scriptures = [] %}
                        {% set general_scriptures = [] %}

                        {% for scripture in analysis.supporting_scripture %}
                            {% if scripture is mapping %}
                                {% if scripture.get('type') == 'positive' %}
                                    {% set _ = positive_scriptures.append(scripture) %}
                                {% elif scripture.get('type') == 'concern' %}
                                    {% set _ = concern_scriptures.append(scripture) %}
                                {% else %}
                                    {% set _ = general_scriptures.append(scripture) %}
                                {% endif %}
                            {% else %}
                                {% set _ = general_scriptures.append(scripture) %}
                            {% endif %}
                        {% endfor %}

                        <!-- Positive Theme Scriptures -->
                        {% if positive_scriptures %}
                            <div class="mb-4">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-heart me-2"></i>Positive Biblical Themes
                                    <span class="badge bg-success ms-2">{{ positive_scriptures|length }}</span>
                                </h6>
                                <div class="scripture-references">
                                    {% for scripture in positive_scriptures %}
                                        <div class="mb-3 p-3 border-start border-success border-4 bg-light scripture-card" data-ref="{{ scripture.get('reference', '') }}">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong class="text-success fs-6">{{ scripture.get('reference', 'Scripture') }}</strong>
                                                {% if scripture.get('theme') %}
                                                    <span class="badge bg-success">{{ scripture.get('theme') | title }}</span>
                                                {% endif %}
                                            </div>
                                            <blockquote class="border-start border-success ps-3 py-2 mb-2 scripture-text">
                                                <em class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Loading verse...</em>
                                            </blockquote>
                                            {% if scripture.get('relevance') %}
                                                <p class="mb-2 small text-success">
                                                    <i class="fas fa-check-circle me-1"></i>
                                                    <strong>Why this matters:</strong> {{ scripture.get('relevance') }}
                                                </p>
                                            {% endif %}
                                            <div class="mt-2">
                                                <a href="https://www.biblegateway.com/passage/?search={{ scripture.get('reference', '')|urlencode }}&version=ESV" 
                                                   target="_blank" rel="noopener" class="btn btn-sm btn-outline-success">
                                                    <i class="fas fa-external-link-alt me-1"></i>Read on Bible Gateway
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Concern-Based Scriptures -->
                        {% if concern_scriptures %}
                            <div class="mb-4">
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-shield-alt me-2"></i>Biblical Basis for Concerns
                                    <span class="badge bg-warning text-dark ms-2">{{ concern_scriptures|length }}</span>
                                </h6>
                                <div class="alert alert-warning p-2 mb-3">
                                    <small>
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Learn to discern:</strong> These scriptures explain why certain content may be spiritually concerning.
                                    </small>
                                </div>
                                <div class="scripture-references">
                                    {% for scripture in concern_scriptures %}
                                        <div class="mb-3 p-3 border-start border-warning border-4 bg-light scripture-card" data-ref="{{ scripture.get('reference', '') }}">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong class="text-warning fs-6">{{ scripture.get('reference', 'Scripture') }}</strong>
                                                {% if scripture.get('theme') %}
                                                    <span class="badge bg-warning text-dark">{{ scripture.get('theme') | title }}</span>
                                                {% endif %}
                                            </div>
                                            <blockquote class="border-start border-warning ps-3 py-2 mb-2 scripture-text">
                                                <em class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Loading verse...</em>
                                            </blockquote>
                                            {% if scripture.get('relevance') %}
                                                <p class="mb-2 small text-dark">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    <strong>Why this is concerning:</strong> {{ scripture.get('relevance') }}
                                                </p>
                                            {% endif %}
                                            <div class="mt-2">
                                                <a href="https://www.biblegateway.com/passage/?search={{ scripture.get('reference', '')|urlencode }}&version=ESV" 
                                                   target="_blank" rel="noopener" class="btn btn-sm btn-outline-warning">
                                                    <i class="fas fa-external-link-alt me-1"></i>Read on Bible Gateway
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- General/Fallback Scriptures -->
                        {% if general_scriptures %}
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-bible me-2"></i>Supporting Scripture
                                    <span class="badge bg-primary ms-2">{{ general_scriptures|length }}</span>
                                </h6>
                                <div class="scripture-references">
                                    {% for scripture in general_scriptures %}
                                        <div class="mb-3 p-3 border-start border-primary border-4 bg-light scripture-card" data-ref="{{ scripture.get('reference') if scripture is mapping else scripture }}">
                                            {% if scripture is mapping %}
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <strong class="text-primary fs-6">{{ scripture.get('reference', 'Scripture') }}</strong>
                                                    {% if scripture.get('theme') %}
                                                        <span class="badge bg-primary">{{ scripture.get('theme') | title }}</span>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <strong class="text-primary fs-6 d-block mb-2">{{ scripture }}</strong>
                                            {% endif %}
                                            <blockquote class="border-start border-primary ps-3 py-2 mb-2 scripture-text">
                                                <em class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Loading verse...</em>
                                            </blockquote>
                                            {% if scripture is mapping and scripture.get('relevance') %}
                                                <p class="mb-2 small">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <strong>Context:</strong> {{ scripture.get('relevance') }}
                                                </p>
                                            {% endif %}
                                            <div class="mt-2">
                                                <a href="https://www.biblegateway.com/passage/?search={{ (scripture.get('reference') if scripture is mapping else scripture)|urlencode }}&version=ESV" 
                                                   target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-external-link-alt me-1"></i>Read on Bible Gateway
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                    {% else %}
                        <!-- Legacy format support -->
                        <h6 class="text-primary mb-3">Related Scripture:</h6>
                        <div class="p-3 border rounded bg-light">
                            <p class="mb-0">{{ analysis.supporting_scripture }}</p>
                        </div>
                    {% endif %}
                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <!-- No Analysis Available -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5>No Analysis Available</h5>
                            <p class="text-muted">This song hasn't been analyzed yet. Click the button below to analyze it now.</p>
                            <button id="analyzeSongBtn" class="btn btn-primary analyze-song-btn" data-analytics="analyze_song_click"
                                    data-song-id="{{ song.id }}"
                                    data-song-title="{{ song.title }}"
                                    data-song-artist="{{ song.artist }}">
                                <i class="fas fa-search me-2"></i>Analyze This Song
                            </button>
                        </div>
                    </div>
                {% endif %}

                <!-- Lyrics Section -->
                {% set has_lyrics = (lyrics and lyrics.strip() and lyrics != "Lyrics not available") or (song.lyrics and song.lyrics.strip() and song.lyrics != "Lyrics not available") %}
                {% if has_lyrics %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-file-lines me-2"></i>Lyrics</h5>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            {% if lyrics and lyrics.strip() and lyrics != "Lyrics not available" %}
                                <pre class="mb-0 lyrics-content">{{ lyrics }}</pre>
                            {% elif song.lyrics and song.lyrics.strip() %}
                                <pre class="mb-0 lyrics-content">{{ song.lyrics }}</pre>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Right Column: Actions & Navigation -->
            <div class="col-lg-4">
                <!-- Actions Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                            <h6 class="mb-0">Actions</h6>
                    </div>
                    <div class="card-body">
        <!-- Re-analyze button (admin only) -->
        {% set is_admin = current_user.is_authenticated and (current_user.is_admin if current_user.is_admin is defined else False) %}
        {% if analysis and is_admin %}
            <div class="d-grid mb-3">
                <button class="btn btn-outline-primary analyze-song-btn" 
                        data-song-id="{{ song.id }}"
                        data-song-title="{{ song.title }}"
                        data-song-artist="{{ song.artist }}">
                    <i class="fas fa-redo me-2"></i>Re-analyze Song
                </button>
            </div>
        {% endif %}

        <!-- User Feedback Hooks (Hidden for now, ready for future implementation) -->
        {% if analysis %}
            <div class="feedback-container d-none" 
                 data-song-id="{{ song.id }}"
                 data-analysis-id="{{ analysis.id }}"
                 data-verdict="{{ analysis.verdict }}"
                 data-score="{{ analysis.score }}">
                <!-- Future: "Was this helpful?" Y/N buttons -->
                <!-- Future: "Report incorrect analysis" button -->
                <!-- Future: Feedback modal for detailed input -->
                <div class="card">
                    <div class="card-body text-center">
                        <p class="mb-3"><strong>Was this analysis helpful?</strong></p>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success feedback-btn" data-feedback="helpful">
                                <i class="fas fa-thumbs-up me-1"></i>Yes
                            </button>
                            <button type="button" class="btn btn-outline-danger feedback-btn" data-feedback="not-helpful">
                                <i class="fas fa-thumbs-down me-1"></i>No
                            </button>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-link text-muted btn-sm report-incorrect-btn">
                                <i class="fas fa-flag me-1"></i>Report incorrect analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Data Attributes (for future JS implementation) -->
            <script type="application/json" id="feedback-config">
            {
                "enabled": false,
                "endpoints": {
                    "submit": "/api/feedback/submit",
                    "report": "/api/feedback/report"
                },
                "metadata": {
                    "song_id": {{ song.id }},
                    "analysis_id": {{ analysis.id }},
                    "user_id": {{ current_user.id if current_user.is_authenticated else 'null' }}
                }
            }
            </script>
        {% endif %}

                        <!-- Remove from Playlist button (only when accessed from playlist context) -->
                        {% if playlist %}
                            <div class="d-grid mb-3">
                                <form action="{{ url_for('main.remove_from_playlist', playlist_id=playlist.id, song_id=song.id) }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                                    <button type="submit" class="btn btn-outline-danger w-100" data-analytics="remove_song_click"
                                            onclick="return confirm('Remove this song from {{ playlist.name }}? This action cannot be undone.')">
                                        <i class="fas fa-trash me-2"></i>Remove from Playlist
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Navigation -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-grid">
                            {% if playlist %}
                                <a href="{{ url_for('main.playlist_detail', playlist_id=playlist.id) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Playlist
                                </a>
                            {% else %}
                                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h4>Song Not Found</h4>
            <p class="text-muted">The requested song could not be found or its details are unavailable.</p>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary mt-3">Return to Dashboard</a>
        </div>
    {% endif %}
</div>

<!-- Song Detail Page-Specific Styles -->
<style>
/* Score circle styling - Using modern design system */
.score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.4rem;
    color: white;
    box-shadow: var(--box-shadow-card);
    transition: var(--transition);
}

.score-excellent {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.score-good {
    background: linear-gradient(135deg, #17a2b8, #20c997);
}

.score-medium {
    background: linear-gradient(135deg, #17a2b8, #6c757d);
}

.score-caution {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.score-poor {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
}

.score-avoid {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
}

/* Better spacing for concerns and themes */
.alert-warning, .alert-success {
    border-left: 4px solid;
    border-radius: var(--border-radius-sm);
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-success {
    border-left-color: #28a745;
}

/* Lyrics content styling */
.lyrics-content {
    white-space: pre-wrap;
    font-family: inherit;
    line-height: 1.7;
    background: transparent;
    border: none;
    color: inherit;
    font-size: 0.95rem;
}

/* Scripture blockquotes */
.blockquote-sm {
    font-size: 0.9rem;
    margin: 0;
    padding-left: 1rem;
    border-left: 3px solid var(--primary-purple);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .score-circle {
        width: 60px;
        height: 60px;
        font-size: 1.1rem;
    }

    .display-6 {
        font-size: 1.75rem;
    }
}
</style>

{# Legacy song-analyzer.js removed; handled by module scripts in base main.js #}

<script>
// Fetch Bible verses for all scripture cards
document.addEventListener('DOMContentLoaded', function() {
    const scriptureCards = document.querySelectorAll('.scripture-card');
    
    scriptureCards.forEach(card => {
        const reference = card.dataset.ref;
        if (!reference) return;
        
        const textElement = card.querySelector('.scripture-text');
        
        // Fetch verse from Bible API
        fetchBibleVerse(reference)
            .then(text => {
                if (text) {
                    textElement.innerHTML = `"${text}"`;
                } else {
                    textElement.innerHTML = '<em class="text-muted">Click "Read on Bible Gateway" to see the full text</em>';
                }
            })
            .catch(err => {
                console.error('Failed to load verse:', reference, err);
                textElement.innerHTML = '<em class="text-muted">Click "Read on Bible Gateway" to see the full text</em>';
            });
    });
});

async function fetchBibleVerse(reference) {
    try {
        // Use bible-api.com (free, no auth required)
        const url = `https://bible-api.com/${encodeURIComponent(reference)}?translation=web`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.text) {
            // Clean up the text (remove verse numbers, extra spaces)
            let text = data.text.trim();
            // Remove verse numbers like "[1]", "[2]", etc.
            text = text.replace(/\[\d+\]/g, '').trim();
            // Remove multiple spaces
            text = text.replace(/\s+/g, ' ');
            return text;
        }
        
        return null;
    } catch (error) {
        console.error('Error fetching verse:', error);
        return null;
    }
}

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
