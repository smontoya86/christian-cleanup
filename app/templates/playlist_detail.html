{% extends "base.html" %}
{% import "bootstrap5/form.html" as wtf %}

{% block content %}
    <div class="container mt-4">
        <h1>{{ playlist.name if playlist else "NO PLAYLIST OBJECT" }}</h1>

        <p>If you see this, the template is loading and the playlist object is somewhat accessible.</p>
        <p>The error might be in the commented out section below.</p>

        <p class="lead">Curated by: {{ playlist.owner_name if playlist and playlist.owner_name else "Unknown Creator" }}</p>
        <div class="mb-3">
            <img src="{{ playlist.image_url if playlist and playlist.image_url else url_for('static', filename='images/default_playlist_image.png') }}" alt="{{ playlist.name if playlist else 'Playlist' }}" class="img-fluid rounded shadow-sm playlist-cover-img-detail">
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{{ url_for('main.analyze_playlist_api', playlist_id=playlist.id) }}" class="btn btn-outline-primary analyze-playlist-btn-api">
                <i class="fas fa-sync-alt"></i> Analyze/Re-analyze Playlist (API)
            </a>
            <button id="toggle-view-btn" class="btn btn-outline-secondary">Switch to Grid View</button>
        </div>
        
        <div class="progress mb-3" style="display: none;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div id="analysis-status" class="mt-2 mb-3"></div>
        <div id="error-message" class="alert alert-danger" style="display: none;"></div>

        <!-- DEBUG: Raw songs_with_status -->
        <div class="debug-output">
            <h4>DEBUG: Raw songs_with_status variable:</h4>
            <p>{{ songs_with_status }}</p>
        </div>

        <!-- DEBUG: Simple list of song titles -->
        <div class="debug-output mt-3">
            <h4>DEBUG: Simple song title list (count: {{ songs_with_status|length }}):</h4>
            {% if songs_with_status %}
                <ul>
                    {% for item in songs_with_status %}
                        <li>{{ item.song.title }} by {{ item.song.artist }} - Status: {{ item.status.display_message if item.status else 'N/A' }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>songs_with_status is empty or not defined.</p>
            {% endif %}
        </div>

        <div id="song-list-view">
            <h3>Songs</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 5%;">#</th>
                            <th scope="col" style="width: 10%;">Art</th>
                            <th scope="col" style="width: 30%;">Title</th>
                            <th scope="col" style="width: 25%;">Artist</th>
                            <th scope="col" style="width: 15%;">Album</th>
                            <th scope="col" style="width: 15%;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if songs_with_status %}
                            {% for item in songs_with_status %}
                            <tr class="{{ 'table-info' if item.is_preferred else '' }}">
                                <th scope="row">{{ loop.index }}</th>
                                <td>
                                    <a href="{{ url_for('main.song_detail', song_id=item.song.id) }}">
                                        <img src="{{ item.song.album_art_url or url_for('static', filename='images/default_album_art.png') }}" alt="{{ item.song.title }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                                    </a>
                                </td>
                                <td><a href="{{ url_for('main.song_detail', song_id=item.song.id) }}">{{ item.song.title }}</a></td>
                                <td>{{ item.song.artist }}</td>
                                <td>{{ item.song.album }}</td>
                                
                                <td class="status-cell {% if item.status and item.status.color_class %}{{ item.status.color_class }}{% else %}bg-light{% endif %}">

                                    <p>DEBUG TEMPLATE: Accessing status for song: {{ item.song.title }}</p>
                                    <p>DEBUG TEMPLATE: item.status object: {{ item.status }}</p>
                                    <p>DEBUG TEMPLATE: Type of item.status: {{ item.status.__class__.__name__ if item.status else 'NoneType' }}</p>

                                    {% if item.status %}
                                        <p>DEBUG TEMPLATE: item.status.color_class is truthy: {{ True if item.status.color_class else False }}</p>
                                        {% if item.status.color_class %}
                                            <p>DEBUG TEMPLATE: color_class value: {{ item.status.color_class }}</p>
                                        {% else %}
                                            <p>DEBUG TEMPLATE: color_class is FALSY or None on item.status. Value: '{{ item.status.color_class }}'</p>
                                        {% endif %}
                                        
                                        <p>DEBUG TEMPLATE: hasattr display_message: {{ item.status.display_message is defined }}</p>
                                        {% if item.status.display_message is defined %}
                                            <p>DEBUG TEMPLATE: display_message value: {{ item.status.display_message }}</p>
                                            {{ item.status.display_message }}
                                        {% else %}
                                            <p>DEBUG TEMPLATE: display_message is UNDEFINED on item.status</p>
                                            N/A (display_message missing)
                                        {% endif %}
                                    {% else %}
                                        <p>DEBUG TEMPLATE: item.status IS NONE.</p>
                                        N/A (status object missing)
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center">No songs found in this playlist or an error occurred.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="song-grid-view" style="display: none;">
        </div>
    </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Javascript will be commented out for now to simplify
</script>
{% endblock %}
